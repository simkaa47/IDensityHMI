<Window x:Class="IDensity.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"               
        xmlns:vm="clr-namespace:IDensity.ViewModels"
        xmlns:pages="clr-namespace:IDensity.Core.Views.Pages"
        xmlns:oxy="http://oxyplot.org/wpf" xmlns:col1="clr-namespace:System.Collections;assembly=System.Runtime.Extensions" xmlns:sys1="clr-namespace:System;assembly=System.Runtime"
        xmlns:wpftool="http://schemas.xceed.com/wpf/xaml/toolkit"
        xmlns:fa="http://schemas.fontawesome.io/icons/"         
        xmlns:add="clr-namespace:IDensity.AddClasses"
        xmlns:i="clr-namespace:System.Windows.Interactivity;assembly=System.Windows.Interactivity"
        xmlns:uc="clr-namespace:IDensity.Views.Resourses.UserControls"
        xmlns:adc="clr-namespace:IDensity.Views.Resourses.UserControls.AdcControls"
        xmlns:sett="clr-namespace:IDensity.AddClasses.Settings"
        xmlns:dt="clr-namespace:IDensity.Core.Views.UserControls.DateTimes"
        mc:Ignorable="d"  
        Background="#000000"
        Title="MainWindow" Height="450" Width="800" WindowState="Maximized">    
    <Window.DataContext>
        <vm:VM/>
    </Window.DataContext>    
        <!--#region Страницы -->
        <Grid>
            <!--#region High Bar -->
            <pages:HighBar/>
            <!--#endregion-->
            <!--#region Вкладки -->
        <TabControl  Grid.Row="1" TabStripPlacement="Bottom" >
            <!--#region Вкладка Измерение -->
            <TabItem Header="Измерение"
                             Tag="..\Pictures\MeasIcon.png"
                             Name="MainTab" 
                             IsSelected="{Binding CurUser.Level, Mode=OneWay, Converter={StaticResource NotEqual}, ConverterParameter={x:Static sys1:String.Empty}}">
                <pages:MainPage/>
            </TabItem>
            <!--#endregion-->
            <!--#region Вкладка Настройки -->
            <TabItem Header="Настройки"
                             Tag="..\Pictures\TuneIcon.png">
                <pages:SettingsPage/>
            </TabItem>
            <!--#endregion-->
            <!--#region НАСТРОЙКИ -->
            <TabItem Header="НАСТРОЙКИ" Visibility="{Binding CurUser, Converter={StaticResource UserToVisibility}, ConverterParameter=Сервис}">
                <TabItem.Resources>
                    <!--#region Общий стиль для DaraGrid -->
                    <Style TargetType="DataGrid">
                        <Setter Property="FontSize" Value="16"/>
                        <Setter Property="FontWeight" Value="Bold"/>
                        <Setter Property="VerticalGridLinesBrush" Value="DarkGray"/>
                        <Setter Property="GridLinesVisibility" Value="Vertical"/>
                        <Setter Property="AlternatingRowBackground" Value="AliceBlue"/>
                        <Setter Property="AutoGenerateColumns" Value="False"/>
                    </Style>
                    <!--#endregion-->
                </TabItem.Resources>
                <TabControl TabStripPlacement="Left" Template="{StaticResource TabControlHorizontalScroll}">                    
                    <!--#region Счетчики -->
                    <TabItem Header="СЧЕТЧИКИ">
                        <UserControl Template="{StaticResource CountersTemplate}" DataContext="{Binding AdcViewModel}"/>
                    </TabItem>
                    <!--#endregion-->
                    <!--#region Общие настройки -->
                    <TabItem Header="ОБЩИЕ НАСТРОЙКИ">
                        <uc:CommonSettingsControl DataContext="{Binding CommonSettingsVm}"/>
                    </TabItem>
                    <!--#endregion-->
                    <!--#region Аналоги -->
                    <TabItem Header="АНАЛОГОВЫЕ МОДУЛИ">
                        <TabItem.Resources>
                            <DataTemplate x:Key="AnalogHeaderTemplate">
                                <TextBlock TextWrapping="Wrap">
                                    <TextBlock.Text>
                                        <Binding/>
                                    </TextBlock.Text>
                                </TextBlock>
                            </DataTemplate>
                        </TabItem.Resources>
                        <StackPanel >
                            <!--#region Аналоговые входы -->
                            <GroupBox  Header="АНАЛОГОВЫЕ ВХОДЫ">
                                <DataGrid AutoGenerateColumns="False" CanUserAddRows="False" CanUserDeleteRows="False" ItemsSource="{Binding AnalogInputs}">
                                    <DataGrid.Columns>
                                        <!--#region Id -->
                                        <DataGridTextColumn IsReadOnly="True"  Header="№" Binding="{Binding GroupNum}"/>
                                        <!--#endregion-->
                                        <!--#region Питание -->
                                        <DataGridTemplateColumn Header="Питание">
                                            <DataGridTemplateColumn.CellTemplate >
                                                <DataTemplate DataType="add:AnalogInput">
                                                    <Button Content="{Binding CommState.Value, Converter={StaticResource StatusFromNum}, ConverterParameter={StaticResource PwrBtnStatus}}"
                                                                            Background="{Binding CommState.Value, Converter={StaticResource ColorToBool}}"
                                                                            Command="{Binding SwitchPwrAmCommand}"></Button>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <!--#endregion-->
                                        <!--#region АЦП -->
                                        <DataGridTextColumn Header="Ток AI, мкА" Binding="{Binding AdcValue.Value}" IsReadOnly="True"/>
                                        <!--#endregion-->
                                        <!--#region Активность -->
                                        <DataGridTemplateColumn Width="120" Header="Активность АЦП" HeaderTemplate="{StaticResource AnalogHeaderTemplate}">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate DataType="add:AnalogInput">
                                                    <ComboBox ItemsSource="{StaticResource On/Off}" SelectedIndex="{Binding Activity.Value, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}">
                                                        <i:Interaction.Triggers>
                                                            <i:EventTrigger EventName="DropDownClosed">
                                                                <i:InvokeCommandAction Command="{Binding SetSettingsCommand}"/>
                                                            </i:EventTrigger>
                                                        </i:Interaction.Triggers>
                                                    </ComboBox>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <!--#endregion-->
                                    </DataGrid.Columns>
                                </DataGrid>
                            </GroupBox>
                            <!--#endregion-->
                            <!--#region AO -->
                            <GroupBox Header="АНАЛОГОВЫЕ ВЫХОДЫ">
                                <DataGrid AutoGenerateColumns="False" CanUserAddRows="False" CanUserDeleteRows="False" ItemsSource="{Binding AnalogOutputs}">
                                    <DataGrid.Columns>
                                        <!--#region Id -->
                                        <DataGridTextColumn IsReadOnly="True"  Header="№" Binding="{Binding GroupNum}"/>
                                        <!--#endregion-->
                                        <!--#region Питание -->
                                        <DataGridTemplateColumn Header="Питание">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate DataType="add:AnalogOutput">
                                                    <Button Content="{Binding CommState.Value, Converter={StaticResource StatusFromNum}, ConverterParameter={StaticResource PwrBtnStatus}}"
                                                                            Background="{Binding CommState.Value, Converter={StaticResource ColorToBool}}"
                                                                            Command="{Binding SwitchPwrAmCommand}" ></Button>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <!--#endregion-->
                                        <!--#region ЦАП -->
                                        <DataGridTextColumn IsReadOnly="True"
                                                                        HeaderTemplate="{StaticResource AnalogHeaderTemplate}"
                                                                        Header="Напряжение ЦАП, каунтов"
                                                                        Binding="{Binding VoltageDac.Value}" 
                                                                        Width="120"/>
                                        <!--#endregion-->
                                        <!--#region Напряжение TEST, мВ -->
                                        <DataGridTextColumn IsReadOnly="True"
                                                                        Header="Напряжение TEST, каунтов"
                                                                        HeaderTemplate="{StaticResource AnalogHeaderTemplate}"
                                                                        Width="120" 
                                                                        Binding="{Binding AdcValue.Value}"/>
                                        <!--#endregion-->
                                        <!--#region Напряжение RX, мВ -->
                                        <DataGridTextColumn Width="120"
                                                                        IsReadOnly="True" 
                                                                        Header="Напряжение RX, каунтов"
                                                                        HeaderTemplate="{StaticResource AnalogHeaderTemplate}"
                                                                        Binding="{Binding VoltageTest.Value}"/>
                                        <!--#endregion-->
                                        <!--#region Тестовое значение, мВ -->
                                        <DataGridTemplateColumn Width="135"
                                                                            HeaderTemplate="{StaticResource AnalogHeaderTemplate}"
                                                                            Header="Тестовое значение, мкА">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate DataType="add:AnalogOutput">
                                                    <DockPanel>
                                                        <StackPanel Orientation="Horizontal" DataContext="{Binding AmTestValue}">
                                                            <TextBox  Width="50" HorizontalAlignment="Left">
                                                                <TextBox.Text>
                                                                    <Binding Path="WriteValue" UpdateSourceTrigger="PropertyChanged" Mode="TwoWay">
                                                                        <Binding.ValidationRules>
                                                                            <DataErrorValidationRule />
                                                                        </Binding.ValidationRules>
                                                                    </Binding>
                                                                </TextBox.Text>
                                                            </TextBox>
                                                            <Button Width="50" Margin="2,0,2,0" Command="{Binding Command}">--></Button>
                                                        </StackPanel>
                                                    </DockPanel>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <!--#endregion-->
                                        <!--#region Активность -->
                                        <DataGridTemplateColumn Width="120"
                                                                            HeaderTemplate="{StaticResource AnalogHeaderTemplate}"
                                                                            Header="Активность ЦАП">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <ComboBox ItemsSource="{StaticResource On/Off}" SelectedIndex="{Binding Activity.WriteValue, UpdateSourceTrigger=PropertyChanged}">
                                                        <i:Interaction.Triggers>
                                                            <i:EventTrigger EventName="DropDownClosed">
                                                                <i:InvokeCommandAction Command="{Binding SetSettingsCommand}"/>
                                                            </i:EventTrigger>
                                                        </i:Interaction.Triggers>
                                                    </ComboBox>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <!--#endregion-->
                                        <!--#region Тип ЦАП -->
                                        <DataGridTemplateColumn Width="120"
                                                                            HeaderTemplate="{StaticResource AnalogHeaderTemplate}"
                                                                            Header="Тип значения">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate DataType="add:AnalogOutput">
                                                    <ComboBox ItemsSource="{StaticResource DacSources}" SelectedIndex="{Binding DacType.WriteValue, UpdateSourceTrigger=PropertyChanged}">
                                                        <i:Interaction.Triggers>
                                                            <i:EventTrigger EventName="DropDownClosed">
                                                                <i:InvokeCommandAction Command="{Binding SetSettingsCommand}"/>
                                                            </i:EventTrigger>
                                                        </i:Interaction.Triggers>
                                                    </ComboBox>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <!--#endregion-->
                                        <!--#region Номер изм. процесса -->
                                        <DataGridTemplateColumn Header="№ изм. процесса" Width="200">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <uc:MenuItemParameterText DataContext="{Binding AnalogMeasProcNdx}"
                                                                                          Command="{Binding RelativeSource={RelativeSource AncestorType=DataGridRow}, Path=DataContext.SetSettingsCommand}"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <!--#endregion-->
                                        <DataGridTemplateColumn Width="120"
                                                                            HeaderTemplate="{StaticResource AnalogHeaderTemplate}"
                                                                            Header="Тип переменной">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <uc:MenuItemCompoboxParameter DataContext="{Binding VarNdx}"
                                                                                              CompoboxWidth="100"                                                                                  
                                                                                              Index="{Binding WriteValue, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}"
                                                                                              Command="{Binding RelativeSource={RelativeSource AncestorType=DataGridRow}, Path=DataContext.SetSettingsCommand}"
                                                                                              ItemSource="{StaticResource VarTypes}"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>

                                        </DataGridTemplateColumn>
                                        <!--#region Нижний предел переменной -->
                                        <DataGridTemplateColumn Header="Нижний предел переменной" 
                                                                            Width="200" 
                                                                            HeaderTemplate="{StaticResource AnalogHeaderTemplate}">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <uc:MenuItemParameterText DataContext="{Binding DacLowLimit}"
                                                                                          Command="{Binding RelativeSource={RelativeSource AncestorType=DataGridRow}, Path=DataContext.SetSettingsCommand}"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <!--#endregion-->
                                        <!--#region Верхний предел переменной -->
                                        <DataGridTemplateColumn Header="Верхний предел переменной" 
                                                                            Width="200" 
                                                                            HeaderTemplate="{StaticResource AnalogHeaderTemplate}">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <uc:MenuItemParameterText DataContext="{Binding DacHighLimit}"
                                                                                          Command="{Binding RelativeSource={RelativeSource AncestorType=DataGridRow}, Path=DataContext.SetSettingsCommand}"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <!--#endregion-->
                                        <!--#region Нижний предел переменной(mA) -->
                                        <DataGridTemplateColumn Header="Нижний предел тока" 
                                                                            Width="200" 
                                                                            HeaderTemplate="{StaticResource AnalogHeaderTemplate}">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <uc:MenuItemParameterText DataContext="{Binding DacLowLimitMa}"
                                                                                          Command="{Binding RelativeSource={RelativeSource AncestorType=DataGridRow}, Path=DataContext.SetSettingsCommand}"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <!--#endregion-->

                                        <!--#region Верхний предел тока -->
                                        <DataGridTemplateColumn Header="Верхний предел тока" 
                                                                            Width="200" 
                                                                            HeaderTemplate="{StaticResource AnalogHeaderTemplate}">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <uc:MenuItemParameterText DataContext="{Binding DacHighLimitMa}"
                                                                                          Command="{Binding RelativeSource={RelativeSource AncestorType=DataGridRow}, Path=DataContext.SetSettingsCommand}"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <!--#endregion-->
                                    </DataGrid.Columns>

                                </DataGrid>
                            </GroupBox>
                            <!--#endregion-->
                        </StackPanel>
                    </TabItem>
                    <!--#endregion-->
                    <!--#region ЕДИНИЦЫ ИЗМЕРЕНИЯ -->
                    <TabItem Header="ЕДИНИЦЫ ИЗМЕРЕНИЯ">
                        <uc:MeasUnitControl DataContext="{Binding MeasUnitSettingsVm}"/>
                    </TabItem>
                    <!--#endregion-->
                    <!--#region Настройки платы HV -->
                    <TabItem Header="ПЛАТА HV" >
                        <ListBox HorizontalContentAlignment="Stretch" >
                            <!--#region Уставка напряжения -->
                            <uc:Parameter DataContext="{Binding mainModel.TelemetryHV.VoltageSV}" 
                                                      Command="{Binding RelativeSource={RelativeSource AncestorType=Window}, Path=DataContext.AdcViewModel.SetHvCommand}" />
                            <!--#endregion-->
                            <!--#region Входное напряжение -->
                            <uc:Parameter DataContext="{Binding mainModel.TelemetryHV.VoltageCurIn}"/>
                            <!--#endregion-->
                            <!--#region Выходное напряжение -->
                            <uc:Parameter DataContext="{Binding mainModel.TelemetryHV.VoltageCurOut}"/>
                            <!--#endregion-->
                            <!--#region Индикатор связи -->
                            <UserControl DataContext="{Binding mainModel.TelemetryHV.HvCommState}" 
                                                         Template="{StaticResource BitIndicator}"/>
                            <!--#endregion-->
                            <!--#region Кнопка включения-выключения HV -->
                            <DockPanel>
                                <TextBlock Style="{StaticResource Common}" 
                                                           Text="Управление Высоким напряжением"/>
                                <Button Width="220" Height="Auto" HorizontalAlignment="Right"
                                                        Background="{Binding mainModel.TelemetryHV.HvOn.Value, Converter={StaticResource ColorToBool}, ConverterParameter=#FFFF0000}"
                                                        Command="{Binding AdcViewModel.switchHvCommandCommand}">
                                    <TextBlock TextWrapping="Wrap" 
                                                               Text="{Binding mainModel.TelemetryHV.HvOn.Value, Converter={StaticResource StatusFromNum}, ConverterParameter={StaticResource HvButn}}"/>
                                </Button>
                            </DockPanel>
                            <!--#endregion-->
                        </ListBox>
                    </TabItem>
                    <!--#endregion-->
                    <!--#region Плата питания -->
                    <TabItem Header="ПЛАТА ПИТАНИЯ">
                        <ListBox HorizontalContentAlignment="Stretch">
                            <!--#region Температура -->
                            <ListBoxItem DataContext="{Binding mainModel.TempTelemetry.TempInternal}" >
                                <uc:Parameter/>
                            </ListBoxItem>
                            <!--#endregion-->

                            <!--#region Индикатор связи -->
                            <ListBoxItem DataContext="{Binding mainModel.TempTelemetry.TempBoardCommState}">
                                <UserControl Template="{StaticResource BitIndicator}"/>
                            </ListBoxItem>
                            <!--#endregion-->
                        </ListBox>
                    </TabItem>
                    <!--#endregion-->
                    <!--#region ДАТА И ВРЕМЯ -->
                    <TabItem Header="ДАТА И ВРЕМЯ">
                        <ListBox HorizontalContentAlignment="Stretch">
                            <ListBox.Resources>
                                <Style TargetType="TextBlock" BasedOn="{StaticResource Common}"/>
                            </ListBox.Resources>
                            <!--#region Реадктирование rtc -->
                            <ListBoxItem>
                                <DockPanel>
                                    <TextBlock Text="{Binding mainModel.Rtc.Description}"/>
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                        <wpftool:DateTimePicker Name="Dt" Value="{Binding mainModel.Rtc.WriteValue}" Margin="1,0,1,0"></wpftool:DateTimePicker>
                                        <Button Command="{Binding SetRtcCommand}" Width="50" Margin="1,0,1,0">--></Button>
                                    </StackPanel>
                                </DockPanel>
                            </ListBoxItem>
                            <!--#endregion-->
                            <!--#region Синхронизация с временем ПК -->
                            <ListBoxItem>
                                <DockPanel>
                                    <TextBlock Text="Синхронизировать с временем ПК"></TextBlock>
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                        <TextBlock Margin="1,0,1,0"  Width="{Binding ElementName=Dt, Path=ActualWidth}" 
                                                                   Text="{Binding CurPcDateTime, StringFormat=F,   UpdateSourceTrigger=PropertyChanged, ConverterCulture=ru-RU,  Mode=OneWay}"
                                                                   HorizontalAlignment="Center"></TextBlock>
                                        <Button Command="{Binding SyncRtcCommand}" Width="50" Margin="1,0,1,0">--></Button>
                                    </StackPanel>
                                </DockPanel>
                            </ListBoxItem>
                            <!--#endregion-->
                        </ListBox>
                    </TabItem>
                    <!--#endregion-->
                    <!--#region Коммуникация -->
                    <TabItem Header="КОММУНИКАЦИЯ" DataContext="{Binding ConnectSettingsVm}">
                        <uc:CommunicationControl/>
                    </TabItem>
                    <!--#endregion-->
                    <!--#region События -->
                    <TabItem Header="СОБЫТИЯ" Visibility="{Binding CurUser, Converter={StaticResource UserToVisibility}, ConverterParameter=Администратор}">
                        <DataGrid ItemsSource="{Binding Events.EventDevices}" 
                                                    AutoGenerateColumns="False"                                        
                                                    CanUserAddRows="False">
                            <DataGrid.Columns>
                                <!--#region ID -->
                                <DataGridTextColumn Header="Id" Binding="{Binding Id}" IsReadOnly="True"/>
                                <!--#endregion-->
                                <DataGridTextColumn Header="Номер" Binding="{Binding Num, StringFormat=d4}"></DataGridTextColumn>
                                <!--#region Заголовок -->
                                <DataGridTextColumn Header="Заголовок" Binding="{Binding Title}"/>
                                <!--#endregion-->
                                <!--#region Описание события -->
                                <DataGridTextColumn Header="Описание события" Binding="{Binding Description}" />
                                <!--#endregion-->
                                <!--#region Активный фон -->
                                <DataGridTemplateColumn Width="120">
                                    <DataGridTemplateColumn.Header>
                                        <TextBlock Text="Активный фон"
                                                               TextWrapping="Wrap"/>
                                    </DataGridTemplateColumn.Header>
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <wpftool:ColorPicker SelectedColor="{Binding ActiveColor, UpdateSourceTrigger=LostFocus}"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <!--#endregion-->
                                <!--#region Неактивный фон -->
                                <DataGridTemplateColumn Width="120">
                                    <DataGridTemplateColumn.Header>
                                        <TextBlock Text="Неактивный фон"
                                                               TextWrapping="Wrap"/>
                                    </DataGridTemplateColumn.Header>
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <wpftool:ColorPicker SelectedColor="{Binding NotActiveColor, UpdateSourceTrigger=LostFocus}"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTemplateColumn Header="Тип" Width="120">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <ComboBox ItemsSource="{StaticResource EventTypes}" SelectedIndex="{Binding Type, UpdateSourceTrigger=PropertyChanged}"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridCheckBoxColumn Binding="{Binding IsActive, UpdateSourceTrigger=PropertyChanged}"/>
                                <!--#endregion-->
                            </DataGrid.Columns>
                        </DataGrid>
                    </TabItem>
                    <!--#endregion-->
                    <!--#region Управление пользователями -->
                    <TabItem Header="ПОЛЬЗОВАТЕЛИ" Visibility="{Binding CurUser, Converter={StaticResource UserToVisibility}, ConverterParameter=Администратор}">
                        <DataGrid  ItemsSource="{Binding Users.Data}">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Логин" Binding="{Binding Login}"/>
                                <DataGridTextColumn Header="Имя" Binding="{Binding Path=Name}"></DataGridTextColumn>
                                <DataGridTextColumn Header="Фамилия" Binding="{Binding Path=Somename}"></DataGridTextColumn>
                                <DataGridComboBoxColumn Header="Уровень доступа" ItemsSource="{StaticResource users}" SelectedItemBinding="{Binding Path=Level}" ></DataGridComboBoxColumn>
                                <DataGridTextColumn Header="Пароль" Binding="{Binding Password}"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </TabItem>
                    <!--#endregion-->
                    <!--#region Перечисления -->
                    <TabItem Header="ПЕРЕЧИСЛЕНИЯ" Visibility="{Binding CurUser, Converter={StaticResource UserToVisibility}, ConverterParameter=Администратор}">
                        <TabItem.Resources>
                            <!--#region Общий шаблон для таблички -->
                            <ControlTemplate x:Key="Enums">
                                <GroupBox Header="{Binding RelativeSource={RelativeSource Mode=TemplatedParent}, Path=Tag}">
                                    <DataGrid ItemsSource="{Binding RelativeSource={RelativeSource Mode=TemplatedParent}, Path=DataContext}"   >
                                        <DataGrid.Columns>
                                            <DataGridTextColumn  Header="Id" Binding="{Binding Id}" IsReadOnly="True"></DataGridTextColumn>
                                            <DataGridTextColumn Header="Name" Binding="{Binding Name}"></DataGridTextColumn>
                                        </DataGrid.Columns>
                                    </DataGrid>
                                </GroupBox>

                            </ControlTemplate>
                            <!--#endregion-->
                        </TabItem.Resources>
                        <WrapPanel>
                            <!--#region Названия Источников компенсаций -->
                            <DataGrid Template="{StaticResource Enums}" DataContext="{Binding CompensationSrcNames.Data}" Tag="Источники компенсаций"></DataGrid>
                            <!--#endregion-->
                            <!--#region Единицы измерения -->
                            <DataGrid Template="{StaticResource Enums}" DataContext="{Binding UnitNames.Data}" Tag="Единицы измерения"></DataGrid>
                            <!--#endregion-->
                            <!--#region Название измерительных процессов -->
                            <DataGrid Template="{StaticResource Enums}" DataContext="{Binding MeasProcNames.Data}" Tag="Измерительные процессы"></DataGrid>
                            <!--#endregion-->
                        </WrapPanel>

                    </TabItem>
                    <!--#endregion-->
                    <!--#region Параметры -->
                    <TabItem Header="ПАРАМЕТРЫ" Visibility="{Binding CurUser, Converter={StaticResource UserToVisibility}, ConverterParameter=Администратор}">
                        <TabItem.Resources>
                            <add:ParamList x:Key="paramsList"/>
                        </TabItem.Resources>
                        <DataGrid ItemsSource="{Binding Source={StaticResource paramsList}, Path=ParameterList}">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Id" Binding="{Binding Id}"></DataGridTextColumn>
                                <DataGridTextColumn Header="Описание" Binding="{Binding Description}"></DataGridTextColumn>
                                <DataGridTextColumn Header="Мин. величина" Binding="{Binding MinValue}"></DataGridTextColumn>
                                <DataGridTextColumn Header="Макс. величина" Binding="{Binding MaxValue}"></DataGridTextColumn>

                            </DataGrid.Columns>
                        </DataGrid>
                    </TabItem>
                    <!--#endregion-->
                    <!--#region Логирование на SD карту -->
                    <TabItem Header="SD КАРТА">
                        <uc:SdCardControl DataContext="{Binding SdCardVm}"/>
                    </TabItem>
                    <!--#endregion-->
                    <!--#region Мастер настроек -->
                    <TabItem Header="МАСТЕР НАСТРОЕК" DataContext="{Binding MasterSettingsViewModel}">
                        <uc:MasterSettingsControl/>
                    </TabItem>
                    <!--#endregion-->
                    <TabItem Header="Переменные состоняий" Visibility="{Binding CurUser, Converter={StaticResource UserToVisibility}, ConverterParameter=Администратор}" >
                        <TabControl TabStripPlacement="Top">
                            <TabControl.Resources>
                                <Style TargetType="DataGridColumnHeader">
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="DataGridColumnHeader">
                                                <TextBlock Text="{TemplateBinding Content}" FontSize="14" FontWeight="Normal" TextWrapping="Wrap"/>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                    <Setter Property="Width" Value="80"/>
                                    <Setter Property="Margin" Value="5"/>
                                </Style>
                                <Style TargetType="TextBlock" BasedOn="{StaticResource Common}"/>
                            </TabControl.Resources>
                            <TabItem Header="Аналоги">
                                <DataGrid ItemsSource="{Binding mainModel.AnalogStateGroups}" AlternationCount="{Binding mainModel.AnalogStateGroups.Length}" IsReadOnly="True">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="Номер группы"  Binding="{Binding AlternationIndex, RelativeSource={RelativeSource AncestorType=DataGridRow}}"/>
                                        <DataGridCheckBoxColumn Header="Выход : нет питания" Binding="{Binding Value, Converter={StaticResource GetBitConverter}, ConverterParameter=0}"/>
                                        <DataGridCheckBoxColumn Header="Вход : нет питания" Binding="{Binding Value, Converter={StaticResource GetBitConverter}, ConverterParameter=1}"/>
                                        <DataGridCheckBoxColumn Header="Выход : нет связи" Binding="{Binding Value, Converter={StaticResource GetBitConverter}, ConverterParameter=2}"/>
                                        <DataGridCheckBoxColumn Header="Вход : нет связи" Binding="{Binding Value, Converter={StaticResource GetBitConverter}, ConverterParameter=3}"/>
                                        <DataGridCheckBoxColumn Header="Выход : ток не в допуске" Binding="{Binding Value, Converter={StaticResource GetBitConverter}, ConverterParameter=4}"/>
                                        <!--<DataGridCheckBoxColumn Header="Выход : опасный ток" Binding="{Binding Value, Converter={StaticResource GetBitConverter}, ConverterParameter=5}"/>-->
                                        <DataGridCheckBoxColumn Header="Выход : напряжение петли не в допуске" Binding="{Binding Value, Converter={StaticResource GetBitConverter}, ConverterParameter=6}"/>
                                        <DataGridCheckBoxColumn Header="Выход : низкое напряжение петли" Binding="{Binding Value, Converter={StaticResource GetBitConverter}, ConverterParameter=7}"/>
                                        <DataGridCheckBoxColumn Header="Выход : цепь разомкнута" Binding="{Binding Value, Converter={StaticResource GetBitConverter}, ConverterParameter=9}"/>
                                        <DataGridCheckBoxColumn Header="Вход : выход напряжения или тока за допуск(11 В или 22 mA)" Binding="{Binding Value, Converter={StaticResource GetBitConverter}, ConverterParameter=10}"/>
                                    </DataGrid.Columns>
                                </DataGrid>
                            </TabItem>
                            <TabItem Header="Физ. параметры платы">

                                <ListBox  HorizontalContentAlignment="Stretch">
                                    <DockPanel>
                                        <TextBlock Text="Питание 12 вольт не в допуске"/>
                                        <CheckBox IsChecked="{Binding mainModel.PhysParamsState, Converter={StaticResource GetBitConverter}, ConverterParameter=0}"
                                                              HorizontalAlignment="Right"/>
                                    </DockPanel>
                                    <DockPanel>
                                        <TextBlock Text="HV не запущено"/>
                                        <CheckBox IsChecked="{Binding mainModel.PhysParamsState, Converter={StaticResource GetBitConverter}, ConverterParameter=1}"
                                                              HorizontalAlignment="Right"/>
                                    </DockPanel>
                                    <DockPanel>
                                        <TextBlock Text="HV не в допуске"/>
                                        <CheckBox IsChecked="{Binding mainModel.PhysParamsState, Converter={StaticResource GetBitConverter}, ConverterParameter=2}"
                                                              HorizontalAlignment="Right"/>
                                    </DockPanel>
                                    <DockPanel>
                                        <TextBlock Text="Опасный уровень HV"/>
                                        <CheckBox IsChecked="{Binding mainModel.PhysParamsState, Converter={StaticResource GetBitConverter}, ConverterParameter=3}"
                                                              HorizontalAlignment="Right"/>
                                    </DockPanel>
                                    <DockPanel>
                                        <TextBlock Text="Ток HV не в допуске"/>
                                        <CheckBox IsChecked="{Binding mainModel.PhysParamsState, Converter={StaticResource GetBitConverter}, ConverterParameter=4}"
                                                              HorizontalAlignment="Right"/>
                                    </DockPanel>
                                    <DockPanel>
                                        <TextBlock Text="Опасный ток HV"/>
                                        <CheckBox IsChecked="{Binding mainModel.PhysParamsState, Converter={StaticResource GetBitConverter}, ConverterParameter=5}"
                                                              HorizontalAlignment="Right"/>
                                    </DockPanel>
                                    <DockPanel>
                                        <TextBlock Text="Температура не в допуске"/>
                                        <CheckBox IsChecked="{Binding mainModel.PhysParamsState, Converter={StaticResource GetBitConverter}, ConverterParameter=6}"
                                                              HorizontalAlignment="Right"/>
                                    </DockPanel>
                                    <DockPanel>
                                        <TextBlock Text="Импульсы не идут"/>
                                        <CheckBox IsChecked="{Binding mainModel.PhysParamsState, Converter={StaticResource GetBitConverter}, ConverterParameter=7}"
                                                              HorizontalAlignment="Right"/>
                                    </DockPanel>
                                    <DockPanel>
                                        <TextBlock Text="HV отключено по допускам"/>
                                        <CheckBox IsChecked="{Binding mainModel.PhysParamsState, Converter={StaticResource GetBitConverter}, ConverterParameter=8}"
                                                              HorizontalAlignment="Right"/>
                                    </DockPanel>
                                    <DockPanel>
                                        <TextBlock Text="RTC некорректен"/>
                                        <CheckBox IsChecked="{Binding mainModel.PhysParamsState, Converter={StaticResource GetBitConverter}, ConverterParameter=9}"
                                                              HorizontalAlignment="Right"/>
                                    </DockPanel>
                                </ListBox>
                            </TabItem>
                        </TabControl>
                    </TabItem>
                    <!--#region Сохранить json -->
                    <TabItem Header="SAVE-LOAD JSON" Visibility="{Binding CurUser, Converter={StaticResource UserToVisibility}, ConverterParameter=Администратор}">
                        <uc:SaveLoadMainModelControl DataContext="{Binding CommonSettingsVm}"/>
                    </TabItem>
                    <!--#endregion-->
                </TabControl>
            </TabItem>
            <!--#endregion-->
            <!--#region Управление -->
            <TabItem Header="УПРАВЛЕНИЕ" Visibility="{Binding CurUser, Converter={StaticResource UserToVisibility}, ConverterParameter=Сервис}">
                <adc:SpectrTuneControl DataContext="{Binding AdcViewModel}"/>
            </TabItem>
            <!--#endregion-->
            <!--#region События -->
            <TabItem Header="СОБЫТИЯ">
                <TabControl TabStripPlacement="Top">
                    <TabItem Header="ВСЕ СОБЫТИЯ">
                        <Grid>
                            <Grid.Resources>
                                <CollectionViewSource x:Key="EventsCollection" Source="{Binding HistoryEventItems}"/>
                            </Grid.Resources>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="40"/>
                                <RowDefinition/>
                            </Grid.RowDefinitions>
                            <!--#region Панель фильтров -->
                            <Grid Grid.Row="0">
                                <UniformGrid Columns="5">
                                    <dt:DateTimeParameter Description="Начальная точка событий"
                                                          DateTimeWidth="200"
                                                          Margin="2"
                                                          DateTime="{Binding StartPointHistoryEvent, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}"/>
                                    <dt:DateTimeParameter Description="Конечная точка событий"
                                                          DateTimeWidth="200"                                              
                                                          Margin="2"
                                                          DateTime="{Binding EndPointHistoryEvent, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}"/>
                                    <Button Margin="2"
                                                        VerticalContentAlignment="Center"
                                                        Command="{Binding ShowEventsCommand}"
                                                       >
                                        <Button.Content>
                                            <StackPanel Orientation="Horizontal">
                                                <fa:ImageAwesome Width="20" 
                                                                             Icon="Refresh" 
                                                                             Foreground="AliceBlue" 
                                                                             Spin="{Binding HistoryItemDownloading}" 
                                                                             Visibility="{Binding HistoryItemDownloading, Converter={StaticResource VisibleConverter}}"/>
                                                <TextBlock Text="Показать" VerticalAlignment="Center"
                                                                       HorizontalAlignment="Center"/>
                                            </StackPanel>
                                        </Button.Content>
                                    </Button>
                                    <Border Margin="2" Style="{StaticResource BorderLight}">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition/>
                                                <ColumnDefinition Width="0.1*"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBox HorizontalContentAlignment="Left"
                                                                 VerticalContentAlignment="Center"
                                                                 Text="{Binding EventFilterText, UpdateSourceTrigger=PropertyChanged}"/>
                                            <fa:ImageAwesome Grid.Column="1" Icon="Search" Width="20" Foreground="AliceBlue"/>
                                        </Grid>
                                    </Border>
                                </UniformGrid>
                            </Grid>
                            <!--#endregion-->
                            <!--#region Таблица всех событий -->
                            <DataGrid Grid.Row="1" 
                                                  IsReadOnly="True" 
                                                  AutoGenerateColumns="False" 
                                                  ItemsSource="{Binding SelectedEventItems}" 
                                                  VirtualizingPanel.VirtualizationMode="Recycling"
                                                  CanUserAddRows="False" 
                                                  CanUserDeleteRows="False">
                                <DataGrid.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <VirtualizingStackPanel/>
                                    </ItemsPanelTemplate>
                                </DataGrid.ItemsPanel>
                                <DataGrid.RowStyle>
                                    <Style TargetType="DataGridRow" BasedOn="{StaticResource EventRowStyle}"/>
                                </DataGrid.RowStyle>
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Время возникновения ошибки" Binding="{Binding EventTime, StringFormat=F,ConverterCulture=ru-RU}"/>
                                    <DataGridTextColumn Header="Пользователь" Binding="{Binding UserName}"/>
                                    <DataGridTextColumn Header="Код события" Binding="{Binding Event.Num, StringFormat=d4}"/>
                                    <DataGridTextColumn Header="Сообщение" Binding="{Binding Event.Title}"/>
                                    <DataGridTextColumn Header="Активность" Binding="{Binding Activity, Converter={StaticResource StatusFromNum}, ConverterParameter={StaticResource Activities}}"/>
                                </DataGrid.Columns>
                            </DataGrid>
                            <!--#endregion-->
                        </Grid>
                    </TabItem>
                    <TabItem Header="ОШИБКИ">
                        <ListView ItemsSource="{Binding Events.EventDevices}">
                            <ListView.ItemContainerStyle>
                                <Style TargetType="ListViewItem">
                                    <Setter Property="Background" Value="{Binding ActiveBrush}"/>
                                    <Setter Property="Visibility" Value="{Binding IsActive, Converter={StaticResource VisibleConverter}}"/>
                                </Style>
                            </ListView.ItemContainerStyle>
                            <ListView.View>
                                <GridView>
                                    <GridViewColumn Header="Номер" DisplayMemberBinding="{Binding Num, StringFormat=d4}"/>
                                    <GridViewColumn Header="Сообщение" DisplayMemberBinding="{Binding Title}"/>
                                    <GridViewColumn Header="Время" DisplayMemberBinding="{Binding LastExecDate}"/>
                                </GridView>
                            </ListView.View>
                        </ListView>
                    </TabItem>
                </TabControl>

            </TabItem>

            <!--#endregion-->
        </TabControl>
        <Grid.RowDefinitions>
                <RowDefinition Height="0.08*" ></RowDefinition>
                <RowDefinition></RowDefinition>
            </Grid.RowDefinitions>
            <!--#endregion-->        
    </Grid>
        <!--#endregion-->   
</Window>
